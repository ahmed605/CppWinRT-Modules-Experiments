# 03-SimpleCustomComponent Notes

This is where things really break down.

This project should build a custom WinRT component for re-use in other projects. You can see how this works just fine for the pch variant of this project, as well as for the pch variant of the `04-CustomConsoleApp`.

As a project consuming the winrt module, this seemingly doesn't work at all. I'm guessing that the auto-generated cppwinrt files for custom components don't work with modules at all.


Where do you put the `import winrt;` in a component like this?
* In the `.cpp`?
  - Above the `#include "Class.h"; #include "Class.g.cpp"`?
    - You'll get 100 errors about various different windows.numerics types being redefined.
  - Below the `#include "Class.h"; #include "Class.g.cpp"`?
    - You'll get a single error about
      ```
      2>    ...\00-WinRTModule\winrt\base.h(538,48): error C2374: 'winrt::take_ownership_from_abi': redefinition; multiple initialization
      2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\base.h(538): message : see declaration of 'winrt::take_ownership_from_abi'
      2>    ...\00-WinRTModule\winrt\Windows.Foundation.h(663): message : see reference to function template instantiation 'auto winrt::impl::consume_Windows_Foundation_IUriRuntimeClass<winrt::Windows::Foundation::IUriRuntimeClass>::Domain(void) const' being compiled
      2>    The command exited with code 2.
      ```
    -
* In the `.h`?
  - Above the `#include "Class.g.h"`?
    - Same numerics errors as before
  - Below the `#include "Class.g.h"`?
    - same `winrt::take_ownership_from_abi` redefinition as before.
* The autogenerated `module.g.cpp` automatically includes `winrt/base.h`, which of course, isn't the module version.
* The autogenerated `winrt\SimpleCustomComponent.h` file _also_ includes `winrt/base.h`.
* If you manually remove the `base.h` references in those files, then you'll get
  ```
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(13,32): error C3856: 'category': symbol is not a class template
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(13,31): error C2143: syntax error: missing ';' before 'winrt::SimpleCustomComponent::IClass'
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(13,14): error C2913: explicit specialization; 'winrt::impl::category' is not a specialization of a class template
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(13,37): error C2059: syntax error: '>'
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(13,38): error C2143: syntax error: missing ';' before '{'
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(13,38): error C2447: '{': missing function header (old-style formal list?)
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(14,101): error C2913: explicit specialization; 'winrt::impl::category' is not a specialization of a class template
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(15,40): error C7568: argument list missing after assumed function template 'name_v'
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(15): error C2062: type 'unknown-type' unexpected
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(16,40): error C7568: argument list missing after assumed function template 'name_v'
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(16): error C2062: type 'unknown-type' unexpected
  2>    ...\03-SimpleCustomComponent\mod\x64\Debug\Generated Files\winrt\impl\SimpleCustomComponent.0.h(17,1): fatal error C1903: unable to recover from previous error(s); stopping compilation
  2>    INTERNAL COMPILER ERROR in 'C:\Program Files\Microsoft Visual Studio\2022\Preview\VC\Tools\MSVC\14.31.30818\bin\HostX64\x64\CL.exe'
  ```
  - Yes this is a compiler error, but this also probably isn't the right solution.


* How should this work?
  - Should the consuming component `#include winrt/base.h` always?
    - Presumably no, the module import should be good enough.
  - Assuming the above answer is no, how do we adjust the winrt codegen that the generated `module.g.cpp` (and projected header) will work?


* You know, the compiler error might be part of this, but also, I don't think the cppwinrt generated code should work. The code in question is

  ```c++
  #pragma once
  #ifndef WINRT_SimpleCustomComponent_0_H
  #define WINRT_SimpleCustomComponent_0_H
  WINRT_EXPORT namespace winrt::SimpleCustomComponent
  {
      struct IClass;
      struct Class;
  }
  namespace winrt::impl
  {
      template <> struct category<winrt::SimpleCustomComponent::IClass>{ using type = interface_category; };
      ...
  ```
  This `category` type is defined in `base.h`, in the `winrt::impl` namespace, which straight up isn't exported. Even if you go through and manually export the winrt::impl bits for `category`, `name_v`, `guid_v` and `default_interface`, then you'll still eventually run into that compiler error.

  It doesn't make sense to export the `winrt::impl` bits, obviously, since those should only be used by types inside the winrt implementation itself.

  So, that gets us to
* A component that's authoring a winrt type should still `#include winrt/base.h`, even if they're using modules.
* If you manually suppress the numerics header,
  - then `import winrt` in the header before `Class.g.h`, then you'll still get a redefinition for basically everything in the `winrt` namespace, from the `base.h` included via the projection's header.
  -
* Changing `take_owner...` to
  `constexpr take_ownership_from_abi_t take_ownership_from_abi{};`
  did not fix it
